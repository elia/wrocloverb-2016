#!/usr/bin/env ruby
$:.unshift "#{__dir__}/../lib"
require 'tretris'

print_score = -> score {
  puts "Points: #{score}"
}

print_next_shape = -> shape_name {
  puts "Next: #{shape_name}"
}

# colors = %w[😀 ❤️ 🎩 🤖 🐸]
# color_map = {}

print_grid = -> grid {
  grid.each do |line|
    print "     |"
    line.each do |cell|
      case cell
      when String, Symbol
        # char = color_map[cell] ||= colors.shift
        char = '🀫'
      else
        char = ' '
      end
      print char #+' '
    end
    puts '|'# end of line
  end
}


game = Tretris::Game.new
commands = "a=left d=right w=rotate s=accelerate"

puts "Usage: #{commands} (anything else does nothing)"
puts "Press Enter to start..."
puts

while command = gets.chomp.downcase
  command.each_char do |char|
    case char.to_sym
    when :a, :"\e[d" then game.move(:left)
    when :d, :"\e[c" then game.move(:right)
    when :w, :"\e[a" then game.move(:up)
    when :s, :"\e[b" then game.move(:down)
    end
  end

  game.tick
  print_score[game.points]
  print_next_shape[game.next_shape.name]
  print_grid[game.lines]

  if game.over?
    warn " GAME OVER ".center(80, "~")
    warn " #{game.points} points ".center(80, "~")
    exit
  else
    print "command (#{commands})> "
  end
end
